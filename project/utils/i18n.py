import streamlit as st
import json
from functools import lru_cache

# Define translations
translations = {
    "pt": {
        # Main menu and titles
        "machine_efficiency_analysis": "An√°lise de Efici√™ncia de M√°quinas",
        "dashboard": "Painel Principal",
        "comparison": "An√°lise Comparativa",
        "data": "Visualiza√ß√£o de Dados",
        "about": "Informa√ß√µes",
        
        # Common terms
        "all": "Todas",
        "all_months": "Todos os Meses",
        "analyze": "Analisar",
        "apply": "Aplicar",
        "availability": "Disponibilidade",
        "clear_data": "Limpar Dados",
        "compare": "Comparar",
        "comparison": "Compara√ß√£o",
        "developed_with": "Desenvolvido com",
        "download": "Baixar",
        "duration": "Dura√ß√£o",
        "duration_minutes": "Dura√ß√£o (minutos)",
        "efficiency": "Efici√™ncia Operacional",
        "export": "Exportar",
        "filter_by": "Filtrar por",
        "frequency": "Frequ√™ncia",
        "from": "De",
        "january": "Janeiro",
        "february": "Fevereiro",
        "march": "Mar√ßo",
        "april": "Abril",
        "may": "Maio",
        "june": "Junho",
        "july": "Julho",
        "august": "Agosto",
        "september": "Setembro",
        "october": "Outubro",
        "november": "Novembro",
        "december": "Dezembro",
        "last_update": "√öltima atualiza√ß√£o",
        "machine": "M√°quina",
        "month": "M√™s",
        "mtbf": "MTBF",
        "mttr": "MTTR",
        "number_of_stoppages": "N√∫mero de Paradas",
        "period": "Per√≠odo",
        "period_select": "Selecionar Per√≠odo",
        "responsible_area": "√Årea Respons√°vel",
        "results": "Resultados",
        "results_analysis": "Resultados da An√°lise",
        "select": "Selecione",
        "select_file": "Selecione um arquivo",
        "select_language": "Selecionar Idioma",
        "select_machine": "Selecione a M√°quina",
        "select_month": "Selecione o M√™s",
        "showing": "Mostrando",
        "stoppages": "Paradas",
        "stoppage_cause": "Causa da Parada",
        "stoppage_type": "Tipo de Parada",
        "summary": "Resumo",
        "to": "At√©",
        "total_duration_hours": "Dura√ß√£o Total (horas)",
        "upload": "Upload",
        "using": "usando",
        "version": "Vers√£o",
        "hours": "horas",
        "days": "dias",
        "indicator": "Indicador",
        "variation": "Varia√ß√£o",
        "status": "Status",
        
        # Dashboard page
        "data_upload": "Upload de Dados",
        "select_excel_file": "Selecione um arquivo Excel com os dados de paradas",
        "file_loaded_success": "Arquivo carregado com sucesso!",
        "records_processed": "registros processados.",
        "error_processing_file": "Erro ao processar o arquivo:",
        "analysis_filters": "Filtros de An√°lise",
        "select_machine": "Selecione a M√°quina:",
        "select_month": "Selecione o M√™s:",
        "custom_period": "Per√≠odo Personalizado",
        "period_start": "Data Inicial:",
        "period_end": "Data Final:",
        "analyze_button": "Analisar",
        "analysis_summary": "Resumo da An√°lise",
        "period_analyzed": "Per√≠odo Analisado:",
        "machine": "M√°quina:",
        "scheduled_time": "Tempo Programado:",
        "total_stoppages": "Total de Paradas:",
        "total_stoppage_time": "Tempo Total de Paradas:",
        "average_time_per_stoppage": "Tempo M√©dio por Parada:",
        "summary_tables": "Tabelas de Resumo",
        "top_10_most_frequent": "Top 10 Paradas Mais Frequentes",
        "top_10_longest": "Top 10 Paradas Mais Longas",
        "temporal_analysis": "An√°lise Temporal",
        "graphical_analysis": "An√°lise Gr√°fica",
        "critical_stoppages_analysis": "An√°lise de Paradas Cr√≠ticas",
        "recommendations": "Recomenda√ß√µes",
        "insights_recommended_actions": "Insights e A√ß√µes Recomendadas",
        "export_results": "Exportar Resultados",
        "download_analyzed_data": "Baixar dados analisados",
        "download_critical_stoppages": "Baixar paradas cr√≠ticas",
        
        # Chart titles
        "pareto_stoppages_title": "Pareto de Causas de Paradas (Top 10 por Dura√ß√£o)",
        "stoppages_by_area_title": "√çndice de Paradas por √Årea Respons√°vel",
        "stoppages_by_month_title": "Taxa de Ocorr√™ncia de Paradas por M√™s",
        "total_duration_by_month_title": "Dura√ß√£o Total de Paradas por M√™s",
        "total_time_by_area_title": "Tempo Total de Paradas por √Årea",
        "critical_stoppages_title": "Top 10 Paradas Cr√≠ticas (>1h)",
        "critical_stoppages_by_area_title": "Distribui√ß√£o de Paradas Cr√≠ticas por √Årea",
        "duration_distribution_title": "Distribui√ß√£o da Dura√ß√£o das Paradas",
        "total_duration_by_machine": "Dura√ß√£o Total por M√°quina",
        
        # Comparison page
        "period_comparison": "Compara√ß√£o de Per√≠odos",
        "period_1": "Per√≠odo 1",
        "period_2": "Per√≠odo 2",
        "comparison_period_start": "Data Inicial",
        "comparison_period_end": "Data Final",
        "compare_button": "Comparar Per√≠odos",
        "comparison_results": "Resultados da Compara√ß√£o",
        "period_1_summary": "Resumo do Per√≠odo 1",
        "period_2_summary": "Resumo do Per√≠odo 2",
        "evolution": "Evolu√ß√£o",
        "metrics_comparison": "Compara√ß√£o de M√©tricas",
        "key_indicators": "Indicadores Chave",
        "improved": "Melhorou",
        "worsened": "Piorou",
        "unchanged": "Sem altera√ß√£o",
        "comparison_conclusions": "Conclus√µes da Compara√ß√£o",
        "metrics_improved": "dos indicadores melhoraram",
        "metrics_worsened": "dos indicadores pioraram",
        "overall_improvement": "Melhoria Geral",
        "overall_deterioration": "Deteriora√ß√£o Geral",
        "performance_unchanged": "Desempenho Inalterado",
        "equal_improvements_deteriorations": "N√∫mero igual de melhorias e deteriora√ß√µes",
        "key_improvements": "Principais Melhorias",
        "areas_for_improvement": "√Åreas para Melhoria",
        "increased_by": "aumentou em",
        "decreased_by": "diminuiu em",
        "recommendations": "Recomenda√ß√µes",
        "excellent_performance_continue": "Excelente desempenho! Continue com as pr√°ticas atuais",
        "document_improvements": "Documente as melhorias implementadas para refer√™ncia futura",
        "set_higher_goals": "Estabele√ßa metas mais ambiciosas para o pr√≥ximo per√≠odo",
        "good_progress_focus_weak_areas": "Bom progresso! Foque nas √°reas que ainda precisam de melhoria",
        "analyze_improvement_factors": "Analise os fatores que contribu√≠ram para as melhorias",
        "implement_targeted_actions": "Implemente a√ß√µes direcionadas para as √°reas com desempenho inferior",
        "identify_priority_metrics": "Identifique os indicadores priorit√°rios para melhoria",
        "establish_improvement_plan": "Estabele√ßa um plano de melhoria estruturado",
        "conduct_root_cause_analysis": "Realize an√°lise de causa raiz para os problemas identificados",
        "urgent_action_needed": "A√ß√£o urgente necess√°ria para reverter a tend√™ncia negativa",
        "conduct_detailed_investigation": "Conduza uma investiga√ß√£o detalhada dos fatores de deteriora√ß√£o",
        "develop_comprehensive_action_plan": "Desenvolva um plano de a√ß√£o abrangente",
        "establish_monitoring_mechanisms": "Estabele√ßa mecanismos de monitoramento mais rigorosos",
        "download_comparison": "Baixar compara√ß√£o",
        
        # Data page
        "data_visualization": "Visualiza√ß√£o dos Dados",
        "filter_by_machine": "Filtrar por M√°quina:",
        "filter_by_month": "Filtrar por M√™s:",
        "showing_records": "Mostrando registros",
        "download_filtered_data": "Baixar dados filtrados",
        "basic_statistics": "Estat√≠sticas B√°sicas",
        "summary_by_machine": "Resumo por M√°quina",
        "number_of_stoppages": "N√∫mero de Paradas",
        "total_duration": "Dura√ß√£o Total",
        "average_duration": "Dura√ß√£o M√©dia",
        "download_machine_summary": "Baixar resumo por m√°quina",
        "additional_analyses": "An√°lises Adicionais",
        "distribution_by_weekday": "Distribui√ß√£o por Dia da Semana",
        "distribution_by_hour": "Distribui√ß√£o por Hora do Dia",
        "weekday": "Dia da Semana",
        "hour_of_day": "Hora do Dia",
        
        # About page
        "about_the_application": "Sobre a Aplica√ß√£o",
        "features": "Funcionalidades",
        "data_analysis": "An√°lise de Dados",
        "additional_resources": "Recursos Adicionais",
        "how_to_use": "Como Usar",
        "data_format": "Formato dos Dados",
        "example_data": "Exemplo de Dados",
        "technologies_used": "Tecnologias Utilizadas",
        "frontend": "Frontend",
        "data_analysis_tech": "An√°lise de Dados",
        "infrastructure": "Infraestrutura",
        "system_requirements": "Requisitos do Sistema",
        
        # Error messages
        "no_data_loaded": "Nenhum dado foi carregado. Por favor, v√° para a p√°gina 'Painel Principal' e fa√ßa o upload de um arquivo Excel.",
        "insufficient_data": "Dados insuficientes para an√°lise.",
        "select_valid_period": "Por favor, selecione um per√≠odo v√°lido para an√°lise.",
        "period_start_after_end": "A data inicial n√£o pode ser posterior √† data final.",
        "analyzing_data": "Analisando dados...",

        # Advanced filters
        "advanced_filters": "Filtros Avan√ßados",
        "only_weekends": "Apenas Fins de Semana",
        "only_night_shift": "Apenas Turno Noturno (22:00-06:00)",
        "responsible_area": "√Årea Respons√°vel",
        "all_areas": "Todas as √Åreas",
        "filter_settings": "Configura√ß√µes de Filtro",
        "apply_filters": "Aplicar Filtros",
        "clear_filters": "Limpar Filtros",
        "filtered_results": "Resultados Filtrados",
        "no_data_after_filters": "Nenhum dado encontrado com os filtros aplicados"
    },
    "en": {
        # Main menu and titles
        "machine_efficiency_analysis": "Machine Efficiency Analysis",
        "dashboard": "Dashboard",
        "comparison": "Comparison",
        "data": "Data",
        "about": "About",
        
        # Common terms
        "all": "All",
        "all_months": "All Months",
        "analyze": "Analyze",
        "apply": "Apply",
        "availability": "Availability",
        "clear_data": "Clear Data",
        "compare": "Compare",
        "comparison": "Comparison",
        "developed_with": "Developed with",
        "download": "Download",
        "duration": "Duration",
        "duration_minutes": "Duration (minutes)",
        "efficiency": "Operational Efficiency",
        "export": "Export",
        "filter_by": "Filter by",
        "frequency": "Frequency",
        "from": "From",
        "january": "January",
        "february": "February",
        "march": "March",
        "april": "April",
        "may": "May",
        "june": "June",
        "july": "July",
        "august": "August",
        "september": "September",
        "october": "October",
        "november": "November",
        "december": "December",
        "last_update": "Last update",
        "machine": "Machine",
        "month": "Month",
        "mtbf": "MTBF",
        "mttr": "MTTR",
        "number_of_stoppages": "Number of Stoppages",
        "period": "Period",
        "period_select": "Select Period",
        "responsible_area": "Responsible Area",
        "results": "Results",
        "results_analysis": "Analysis Results",
        "select": "Select",
        "select_file": "Select a file",
        "select_language": "Select Language",
        "select_machine": "Select Machine",
        "select_month": "Select Month",
        "showing": "Showing",
        "stoppages": "Stoppages",
        "stoppage_cause": "Stoppage Cause",
        "stoppage_type": "Stoppage Type",
        "summary": "Summary",
        "to": "To",
        "total_duration_hours": "Total Duration (hours)",
        "upload": "Upload",
        "using": "using",
        "version": "Version",
        "hours": "hours",
        "days": "days",
        "indicator": "Indicator",
        "variation": "Variation",
        "status": "Status",
        
        # Dashboard page
        "data_upload": "Data Upload",
        "select_excel_file": "Select an Excel file with stoppage data",
        "file_loaded_success": "File loaded successfully!",
        "records_processed": "records processed.",
        "error_processing_file": "Error processing file:",
        "analysis_filters": "Analysis Filters",
        "select_machine": "Select Machine:",
        "select_month": "Select Month:",
        "custom_period": "Custom Period",
        "period_start": "Start Date:",
        "period_end": "End Date:",
        "analyze_button": "Analyze",
        "analysis_summary": "Analysis Summary",
        "period_analyzed": "Period Analyzed:",
        "machine": "Machine:",
        "scheduled_time": "Scheduled Time:",
        "total_stoppages": "Total Stoppages:",
        "total_stoppage_time": "Total Stoppage Time:",
        "average_time_per_stoppage": "Average Time per Stoppage:",
        "summary_tables": "Summary Tables",
        "top_10_most_frequent": "Top 10 Most Frequent Stoppages",
        "top_10_longest": "Top 10 Longest Stoppages",
        "temporal_analysis": "Temporal Analysis",
        "graphical_analysis": "Graphical Analysis",
        "critical_stoppages_analysis": "Critical Stoppages Analysis",
        "recommendations": "Recommendations",
        "insights_recommended_actions": "Insights and Recommended Actions",
        "export_results": "Export Results",
        "download_analyzed_data": "Download analyzed data",
        "download_critical_stoppages": "Download critical stoppages",
        
        # Chart titles
        "pareto_stoppages_title": "Pareto of Stoppage Causes (Top 10 by Duration)",
        "stoppages_by_area_title": "Stoppage Index by Responsible Area",
        "stoppages_by_month_title": "Stoppage Occurrence Rate by Month",
        "total_duration_by_month_title": "Total Stoppage Duration by Month",
        "total_time_by_area_title": "Total Stoppage Time by Area",
        "critical_stoppages_title": "Top 10 Critical Stoppages (>1h)",
        "critical_stoppages_by_area_title": "Distribution of Critical Stoppages by Area",
        "duration_distribution_title": "Distribution of Stoppage Durations",
        "total_duration_by_machine": "Total Duration by Machine",
        
        # Comparison page
        "period_comparison": "Period Comparison",
        "period_1": "Period 1",
        "period_2": "Period 2",
        "comparison_period_start": "Start Date",
        "comparison_period_end": "End Date",
        "compare_button": "Compare Periods",
        "comparison_results": "Comparison Results",
        "period_1_summary": "Period 1 Summary",
        "period_2_summary": "Period 2 Summary",
        "evolution": "Evolution",
        "metrics_comparison": "Metrics Comparison",
        "key_indicators": "Key Indicators",
        "improved": "Improved",
        "worsened": "Worsened",
        "unchanged": "Unchanged",
        "comparison_conclusions": "Comparison Conclusions",
        "metrics_improved": "of metrics improved",
        "metrics_worsened": "of metrics worsened",
        "overall_improvement": "Overall Improvement",
        "overall_deterioration": "Overall Deterioration",
        "performance_unchanged": "Performance Unchanged",
        "equal_improvements_deteriorations": "Equal number of improvements and deteriorations",
        "key_improvements": "Key Improvements",
        "areas_for_improvement": "Areas for Improvement",
        "increased_by": "increased by",
        "decreased_by": "decreased by",
        "recommendations": "Recommendations",
        "excellent_performance_continue": "Excellent performance! Continue with current practices",
        "document_improvements": "Document implemented improvements for future reference",
        "set_higher_goals": "Set higher goals for the next period",
        "good_progress_focus_weak_areas": "Good progress! Focus on areas still needing improvement",
        "analyze_improvement_factors": "Analyze factors that contributed to improvements",
        "implement_targeted_actions": "Implement targeted actions for underperforming areas",
        "identify_priority_metrics": "Identify priority metrics for improvement",
        "establish_improvement_plan": "Establish a structured improvement plan",
        "conduct_root_cause_analysis": "Conduct root cause analysis for identified issues",
        "urgent_action_needed": "Urgent action needed to reverse negative trend",
        "conduct_detailed_investigation": "Conduct detailed investigation of deterioration factors",
        "develop_comprehensive_action_plan": "Develop comprehensive action plan",
        "establish_monitoring_mechanisms": "Establish more rigorous monitoring mechanisms",
        "download_comparison": "Download comparison",
        
        # Data page
        "data_visualization": "Data Visualization",
        "filter_by_machine": "Filter by Machine:",
        "filter_by_month": "Filter by Month:",
        "showing_records": "Showing records",
        "download_filtered_data": "Download filtered data",
        "basic_statistics": "Basic Statistics",
        "summary_by_machine": "Summary by Machine",
        "number_of_stoppages": "Number of Stoppages",
        "total_duration": "Total Duration",
        "average_duration": "Average Duration",
        "download_machine_summary": "Download machine summary",
        "additional_analyses": "Additional Analyses",
        "distribution_by_weekday": "Distribution by Weekday",
        "distribution_by_hour": "Distribution by Hour of Day",
        "weekday": "Weekday",
        "hour_of_day": "Hour of Day",
        
        # About page
        "about_the_application": "About the Application",
        "features": "Features",
        "data_analysis": "Data Analysis",
        "additional_resources": "Additional Resources",
        "how_to_use": "How to Use",
        "data_format": "Data Format",
        "example_data": "Example Data",
        "technologies_used": "Technologies Used",
        "frontend": "Frontend",
        "data_analysis_tech": "Data Analysis",
        "infrastructure": "Infrastructure",
        "system_requirements": "System Requirements",
        
        # Error messages
        "no_data_loaded": "No data has been loaded. Please go to the 'Dashboard' page and upload an Excel file.",
        "insufficient_data": "Insufficient data for analysis.",
        "select_valid_period": "Please select a valid period for analysis.",
        "period_start_after_end": "The start date cannot be after the end date.",
        "analyzing_data": "Analyzing data...",

        # Advanced filters
        "advanced_filters": "Advanced Filters",
        "only_weekends": "Weekends Only",
        "only_night_shift": "Night Shift Only (22:00-06:00)",
        "responsible_area": "Responsible Area",
        "all_areas": "All Areas",
        "filter_settings": "Filter Settings",
        "apply_filters": "Apply Filters",
        "clear_filters": "Clear Filters",
        "filtered_results": "Filtered Results",
        "no_data_after_filters": "No data found with applied filters"
    }
}

@lru_cache(maxsize=128)
def get_translation(language=None):
    """Get translations for the specified language."""
    if language is None and 'language' in st.session_state:
        language = st.session_state.language
    elif language is None:
        language = 'pt'  # Default to Portuguese
    
    def translate(key):
        if key in translations[language]:
            return translations[language][key]
        # Fallback to English if key not found in current language
        elif key in translations['en']:
            return translations['en'][key]
        else:
            return key  # Return the key itself if not found in any language
    
    return translate

def setup_language_selector():
    """Set up the language selector in the sidebar."""
    st.sidebar.title("üåê " + ("Language" if st.session_state.language == 'en' else "Idioma"))
    
    # Create a container for the language buttons
    lang_container = st.sidebar.container()
    
    # Create two columns for the language buttons
    col1, col2 = lang_container.columns(2)
    
    # Portuguese button
    if col1.button("üáßüá∑ Portugu√™s", use_container_width=True, 
                   type="primary" if st.session_state.language == 'pt' else "secondary"):
        st.session_state.language = 'pt'
        st.rerun()
    
    # English button
    if col2.button("üá∫üá∏ English", use_container_width=True,
                   type="primary" if st.session_state.language == 'en' else "secondary"):
        st.session_state.language = 'en'
        st.rerun()
    
    # Add some space
    st.sidebar.markdown("---")
